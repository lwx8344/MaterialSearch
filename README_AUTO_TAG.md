# 自动标签功能使用说明

## 功能概述

自动标签功能利用 MaterialSearch 的向量数据库和 CLIP 模型，为图片和视频自动添加描述性标签，并支持根据标签自动重命名文件。

## 主要特性

1. **智能标签识别**: 使用 CLIP 模型分析图片和视频内容，自动识别场景、物体、颜色等特征
2. **中英文标签支持**: 提供中英文对照的标签库，支持中文用户使用
3. **批量处理**: 支持批量处理数据库中的所有图片和视频
4. **自动重命名**: 根据识别出的标签自动重命名文件
5. **缓存机制**: 标签向量计算结果会被缓存，提高后续运行效率

## 文件说明

- `auto_tag.py`: 主要的自动标签脚本
- `tag_vocabulary.py`: 候选标签库，包含中英文对照的标签
- `test_auto_tag.py`: 测试脚本，用于验证功能是否正常
- `README_AUTO_TAG.md`: 本说明文档

## 安装依赖

确保已安装 MaterialSearch 的所有依赖：

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 基本使用

```bash
# 为所有图片和视频添加标签（不重命名文件）
python auto_tag.py

# 为所有图片和视频添加标签并重命名文件
python auto_tag.py --rename

# 只处理图片
python auto_tag.py --images-only

# 只处理视频
python auto_tag.py --videos-only

# 只处理图片并重命名
python auto_tag.py --images-only --rename
```

### 2. 测试功能

在正式使用前，建议先运行测试脚本：

```bash
python test_auto_tag.py
```

测试脚本会检查：
- 模块导入是否正常
- 标签向量计算是否成功
- 相似度计算是否正常

### 3. 自定义标签

如需添加或修改标签，请编辑 `tag_vocabulary.py` 文件：

```python
TAG_VOCABULARY = {
    "你的中文标签": "your_english_tag",
    # 添加更多标签...
}
```

**注意**: 
- 中文标签用于显示和文件名生成
- 英文标签用于 CLIP 模型处理
- 修改标签后需要删除 `tag_vectors.pkl` 缓存文件重新计算

## 工作流程

### 1. 标签向量化
- 脚本首次运行时会计算所有候选标签的向量
- 计算结果保存在 `tag_vectors.pkl` 文件中
- 后续运行会直接加载缓存，提高效率

### 2. 图片处理
- 从数据库读取图片特征向量
- 计算图片特征与所有标签向量的相似度
- 选择相似度最高的前5个标签
- 将标签保存到数据库

### 3. 视频处理
- 从数据库读取视频的所有关键帧特征
- 为每个关键帧计算标签相似度
- 统计所有帧的标签频率
- 选择出现频率最高的标签作为视频标签

### 4. 文件重命名（可选）
- 根据识别出的标签生成新文件名
- 格式：`标签1_标签2_标签3.扩展名`
- 自动处理文件名冲突

## 配置参数

可以在 `auto_tag.py` 中调整以下参数：

```python
# 相似度阈值，低于此值的标签会被过滤
threshold = 0.3

# 返回的标签数量
top_k = 5  # 图片
top_k = 3  # 视频帧

# 视频标签最小出现次数
min_count = 2
```

## 注意事项

1. **首次运行**: 首次运行时会计算标签向量，可能需要较长时间
2. **数据库更新**: 确保数据库中的图片和视频特征是最新的
3. **文件权限**: 重命名功能需要文件写入权限
4. **标签质量**: 标签识别效果取决于 CLIP 模型和标签库质量
5. **缓存管理**: 修改标签库后需要删除缓存文件

## 故障排除

### 常见问题

1. **torch.norm 错误**
   - 确保已正确安装 torch
   - 检查 torch 版本兼容性

2. **标签向量计算失败**
   - 检查网络连接（首次下载模型）
   - 确保有足够的内存和显存

3. **数据库连接错误**
   - 确保数据库文件存在
   - 检查数据库权限

4. **文件重命名失败**
   - 检查文件权限
   - 确保文件没有被其他程序占用

### 日志查看

脚本运行时会输出详细的日志信息，包括：
- 处理进度
- 错误信息
- 标签识别结果

## 扩展功能

### 添加新的标签类别

1. 在 `tag_vocabulary.py` 中添加新标签
2. 删除 `tag_vectors.pkl` 缓存文件
3. 重新运行脚本

### 自定义相似度计算

可以修改 `compute_similarity` 方法来实现不同的相似度计算方式。

### 集成到 Web 界面

可以将自动标签功能集成到 MaterialSearch 的 Web 界面中，提供在线标签服务。

## 技术支持

如遇到问题，请：
1. 查看日志输出
2. 运行测试脚本
3. 检查配置参数
4. 联系技术支持 